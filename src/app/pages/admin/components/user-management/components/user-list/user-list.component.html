<div class="user-container">
  <div class="header">
    <h1>User Management</h1>
    <button
      mat-raised-button
      color="primary"
      (click)="openInviteDialog()"
      aria-label="Invite new admin"
    >
      <mat-icon>person_add</mat-icon>
      Invite Admin
    </button>
  </div>

  @if(isLoading()){
  <div class="loading-state">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading users...</p>
  </div>
  } @if(error() && !isLoading()) {
  <div class="error-state mat-elevation-z2">
    <mat-icon>error_outline</mat-icon>
    <div class="error-message">
      <h3>Something went wrong</h3>
      <p>{{ error() }}</p>
    </div>
    <button
      mat-stroked-button
      color="primary"
      (click)="loadUsers()"
      aria-label="Retry loading users"
    >
      <mat-icon>refresh</mat-icon>
      Try Again
    </button>
  </div>
  } @if(!isLoading() && !error()) {
  <div class="table-container mat-elevation-z2">
    <table
      mat-table
      [dataSource]="users()"
      matSort
      (matSortChange)="onSortChange($event)"
      aria-label="Users list"
    >
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
        <td mat-cell *matCellDef="let user">{{ user.id }}</td>
      </ng-container>

      <ng-container matColumnDef="avatar">
        <th mat-header-cell *matHeaderCellDef>Avatar</th>
        <td mat-cell *matCellDef="let user">
          <img
            [src]="user.avatarUrl || 'assets/default-avatar.png'"
            alt="{{ user.username }}'s avatar"
            class="avatar"
          />
        </td>
      </ng-container>

      <ng-container matColumnDef="username">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Username</th>
        <td mat-cell *matCellDef="let user">{{ user.username }}</td>
      </ng-container>

      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
        <td mat-cell *matCellDef="let user">
          <a [href]="'mailto:' + user.email" class="email-link">
            {{ user.email }}
          </a>
        </td>
      </ng-container>

      <ng-container matColumnDef="role">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Role</th>
        <td mat-cell *matCellDef="let user">
          <app-user-role-chip [role]="user.role"></app-user-role-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let user">
          <app-user-status-chip [active]="user.active"></app-user-status-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Joined</th>
        <td mat-cell *matCellDef="let user">
          {{ user.createdAt | date : "mediumDate" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let user">
          <button
            mat-icon-button
            [matMenuTriggerFor]="menu"
            aria-label="User actions menu"
          >
            <mat-icon>more_vert</mat-icon>
          </button>

          <mat-menu #menu="matMenu">
            <button
              mat-menu-item
              (click)="viewUserDetails(user)"
              aria-label="View user details"
            >
              <mat-icon>visibility</mat-icon>
              <span>View Details</span>
            </button>

            @if (user.role === 'USER') {
            <button
              mat-menu-item
              (click)="promoteUser(user)"
              aria-label="Promote to admin"
            >
              <mat-icon>arrow_upward</mat-icon>
              <span>Promote to Admin</span>
            </button>
            } @if (user.role === 'ADMIN') {
            <button
              mat-menu-item
              (click)="demoteUser(user)"
              aria-label="Demote to user"
            >
              <mat-icon>arrow_downward</mat-icon>
              <span>Demote to User</span>
            </button>
            }

            <!-- Activate/Deactivate -->
            @if (user.active) {
            <button
              mat-menu-item
              (click)="deactivateUser(user)"
              aria-label="Deactivate user"
            >
              <mat-icon>toggle_off</mat-icon>
              <span>Deactivate</span>
            </button>
            } @else {
            <button
              mat-menu-item
              (click)="reactivateUser(user)"
              aria-label="Reactivate user"
            >
              <mat-icon>toggle_on</mat-icon>
              <span>Reactivate</span>
            </button>
            }
            <button
              mat-menu-item
              (click)="deleteUser(user)"
              aria-label="Delete user"
              class="delete-action"
            >
              <mat-icon color="warn">delete</mat-icon>
              <span class="warn-text">Delete</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns()"
        [class.inactive-user]="!row.active"
      ></tr>
    </table>

    @if (users().length === 0) {
    <div class="empty-state">
      <mat-icon>group_off</mat-icon>
      <h3>No users found</h3>
      <p>There are currently no users in the system</p>
    </div>
    }

    <mat-paginator
      [length]="totalItems()"
      [pageSize]="pageSize()"
      [pageSizeOptions]="[5, 10, 25, 50]"
      [pageIndex]="currentPage()"
      (page)="onPageChange($event)"
      aria-label="Select page of users"
      showFirstLastButtons
    >
    </mat-paginator>
  </div>
  }
  <admin-recent-users />
</div>
